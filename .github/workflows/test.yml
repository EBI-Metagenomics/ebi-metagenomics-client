name: Testing

on: [ push, pull_request ]
env:
  EMG_CONFIG: ${{ github.workspace }}/client-repo/ci/config.yaml
  API_URL: http://localhost:9000/metagenomics/api/v1/
  API_V2_URL: http://localhost:8000/
  SEARCH_URL: https://www.ebi.ac.uk/ebisearch/ws/rest/metagenomics_
  VITE_BASE_URL: /metagenomics
  BASE_URL: http://localhost:9000/metagenomics/
  INTERPRO_URL: http://www.ebi.ac.uk/interpro/
  SEQUENCE_SEARCH_URL: https://wwwdev.ebi.ac.uk/metagenomics/sequence-search/search/phmmer
  ENA_URL: https://www.ebi.ac.uk/ena/browser/view/
  CYPRESS_WEBIN_USERNAME: Webin-000
  CYPRESS_WEBIN_PASSWORD: secret

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: client-repo

      - name: âš™ï¸ - Settings
        working-directory: client-repo
        env: # Or as an environment variable
          MAPS_KEY: ${{ secrets.GOOGLE_MAPS_DEV_KEY }}
        run: |
          echo "{\"googleMapsKey\": \"$MAPS_KEY\", \"api\": \"$API_URL\", \"api_v2\": \"$API_V2_URL\"}" > "$(pwd)/config.private.json"

      - name: ðŸ“œ - Set up JS Node 23
        uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'npm'
          cache-dependency-path: client-repo/package-lock.json

      - name: ðŸ”§ - Install deps
        working-directory: client-repo
        run: |
          npm ci
          npm i -g concurrently

      - name: ðŸ§¹ - ESlint
        working-directory: client-repo
        run: |
          npm run eslint

      - name: ðŸ§ª - Testing
        uses: cypress-io/github-action@v6
        with:
          working-directory: client-repo
          browser: chrome
          start: concurrently -k "npm run serve:fixtures" "npm run start"
          wait-on: http://localhost:9000/
          wait-on-timeout: 60
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

      - name: ðŸ“‰ - Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          directory: ${{ github.workspace }}/client-repo/coverage/

#      TODO: enable sentry when https://github.com/getsentry/action-release/issues/83 is resolved
#      - name: Sentry Release
#        uses: getsentry/action-release@v1.1.6
#        working-directory: 'client-repo'
#        env:
#          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
#          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
#          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
#          SENTRY_LOG_LEVEL: 'info'
#        with:
#          environment: dev
#          sourcemaps: './dist/js'
#          version: ${{ github.sha }}

      - name: ðŸ“¸ - Failed tests snapshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: tests-snapshots
          path: /home/runner/work/ebi-metagenomics-client/ebi-metagenomics-client/client-repo/cypress/screenshots/ # - name: ðŸ“Š - Coverage

      - name: ðŸ“® - Slack Notification
        uses: rtCamp/action-slack-notify@v2
        continue-on-error: true
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
        env:
          SLACK_COLOR: "${{ job.status == 'success' && 'good' || 'danger' }}"
          SLACK_USERNAME: 'Github Actions API'
          SLACK_ICON_EMOJI: ':octocat:'
          SLACK_TITLE: 'webkit results in GitHub Actions'
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: '#metagenomics-notify'
          MSG_MINIMAL: Actions URL
