name: Testing

on: [ push, pull_request ]
env:
  EMG_CONFIG: ${{ github.workspace }}/ci/config.yaml
  SEARCH_URL: https://www.ebi.ac.uk/ebisearch/ws/rest/metagenomics_
  DEPLOYMENT_SUBFOLDER: /metagenomics
  BASE_URL: http://localhost:9000/metagenomics/
  INTERPRO_URL: http://www.ebi.ac.uk/interpro/
  SEQUENCE_SEARCH_URL: https://wwwdev.ebi.ac.uk/metagenomics/sequence-search/search/phmmer
  ENA_URL: https://www.ebi.ac.uk/ena/browser/view/
  CYPRESS_WEBIN_USERNAME: Webin-000
  CYPRESS_WEBIN_PASSWORD: secret

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: ‚öôÔ∏è - Settings
        env: # Or as an environment variable
          MAPS_KEY: ${{ secrets.GOOGLE_MAPS_DEV_KEY }}
        run: |
          echo "{\"googleMapsKey\": \"$MAPS_KEY\"}" > "$(pwd)/config.private.json"
      - name: üåé - Setup NginX
        run: |
          sudo chmod 777 /var/log/nginx/*
          sudo chmod 777 /var/run/*
          sudo chmod 777 /var/run
          sed -i s#{GITHUB_WORKSPACE}#$GITHUB_WORKSPACE#g ci/nginx.conf
          nginx -c "$(pwd)/ci/nginx.conf"
      - name: üêç - Set up Python 3.6
        uses: actions/setup-python@v2
        with:
          python-version: 3.6
      - name: üìú - Set up JS Node 14
        uses: actions/setup-node@v1
        with:
          node-version: '14'
      - name: üíæ Start MongoDB
        uses: supercharge/mongodb-github-action@1.3.0
        with:
          mongodb-version: 4.0.6
      # TODO: ‚ö†Ô∏è the json genereted is not understood by codecov
      - name: üîß - Install
        run: |
          npm ci
          npm run build
          npm run coverage:instrument 
          cp -r dist metagenomics
          mv metagenomics /usr/share/nginx/html/metagenomics
          cp -r coverage/instrumented/* /usr/share/nginx/html/metagenomics/
          ls /usr/share/nginx/html/metagenomics
          echo "=== web index ==="
          curl --silent http://localhost:9000/metagenomics/
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
      - name: üßπ - ESlint
        run: |
          npm run eslint
      - name: üß™ - Testing
        uses: cypress-io/github-action@v2
        with:
          spec: |
            cypress/integration/index.js
            cypress/integration/about.js
            cypress/integration/help.js
            cypress/integration/search.js
            cypress/integration/sample.js
      - name: üìâ - Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          directory: ${{ github.workspace }}/coverage/
      - name: ‚öôÔ∏è - Rebuild for deployment
        if: github.ref == 'refs/heads/new-client'
        run: |
          echo "{\"googleMapsKey\": \"$MAPS_KEY\", \"basename\": \"\/ebi-metagenomics-client\"}" > "$(pwd)/config.private.json"
          npm run clean
          npm run build
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
      - name: Sentry Release
        uses: getsentry/action-release@v1.0.0
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        with:
          environment: dev
      - name: üöÄ - Deploy Site
        if: github.ref == 'refs/heads/new-client'
        uses: JamesIves/github-pages-deploy-action@3.7.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages # The branch the action should deploy to.
          FOLDER: dist # The folder the action should deploy.
          CLEAN: true # Automatically remove deleted files from the deploy branch
      - name: üì∏ - Failed tests snapshots
        uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: tests-snapshots
          path: /home/runner/work/ebi-metagenomics-client/ebi-metagenomics-client/cypress/screenshots/ # - name: üìä - Coverage
      - name: üêû - Error log
        if: failure()
        run: |
          echo "NGINX error log"
          cat /var/log/nginx/error.log
          echo "NGINX access log"
          cat /var/log/nginx/access.log
      - name: üìÆ - Slack Notification
        uses: rtCamp/action-slack-notify@v2
        continue-on-error: true
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
        env:
          SLACK_COLOR: "${{ job.status == 'success' && 'good' || 'danger' }}"
          SLACK_USERNAME: 'Github Actions API'
          SLACK_ICON_EMOJI: ':octocat:'
          SLACK_TITLE: 'webkit results in GitHub Actions'
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: '#metagenomics-notify'
          MSG_MINIMAL: Actions URL
