var canvas,context,svg,collapseCheckBox,collapseLast,compress,compressCheckBox,maxAbsoluteDepthText,maxAbsoluteDepthButtonDecrease,maxAbsoluteDepthButtonIncrease,fontSizeText,fontSizeButtonDecrease,fontSizeButtonIncrease,fontSizeLast,radiusButtonDecrease,radiusButtonIncrease,shorten,shortenCheckBox,maxAbsoluteDepth,backButton,upButton,forwardButton,snapshotButton,details,detailsName,search,searchResults,nSearchResults,useHueCheckBox,useHueDiv,datasetDropDown,datasetButtonLast,datasetButtonPrev,datasetButtonNext,keyControl,linkButton,linkText,frame,head,mouseDownTime,imageWidth,imageHeight,centerX,centerY,gRadius,buffer,keySize,keys,currentKey,keyMinTextLeft,keyMinAngle,maxPossibleDepth,maxDisplayDepth,fontNormal,fontBold,nodeRadius,angleFactor,tickLength,compressedRadii,labelOffsets,labelLastNodes,labelFirstNodes,tweenStartTime,magnitudeIndex,membersAssignedIndex,membersSummaryIndex,hueDisplayName,hueStopPositions,hueStopHues,hueStopText,datasetNames,datasetChanged,image,hiddenPattern,loadingImage,logoImage,margin,hueStopHsl,detailsExpand,detailsInfo,nodeData,lightnessFactor,options,collapse=!0,fontSize=11,snapshotMode=!1,showKeys=!0,selectedNode=0,focusNode=0,highlightedNode=0,highlightingHidden=!1,nodes=[],currentNodeID=0,nodeHistory=[],nodeHistoryPosition=0,dataEnabled=!1,getVariables=[],selectedNodeLast=0,zoomOut=!1,quickLook=!1,mouseDown=!1,quickLookHoldLength=200,updateViewNeeded=!1,rotationOffset=Math.PI/2,bufferFactor=.1,mapBuffer=10,mapRadius=0,maxMapRadius=25,mapWidth=150,maxLabelOverhang=4.18*Math.PI,maxKeySizeFactor=2,keyBuffer=10,minRingWidthFactor=5,headerHeight=0,historySpacingFactor=1.6,historyAlphaDelta=.25,lineOpacity=.3,saturation=.5,lightnessBase=.6,lightnessMax=.8,thinLineWidth=.3,highlightLineWidth=1.5,labelBoxBuffer=6,labelBoxRounding=15,labelWidthFudge=1.05,fontFamily="sans-serif",highlightFill="rgba(255, 255, 255, .3)",colorUnclassified="rgb(220,220,220)",nLabelOffsets=3,mouseX=-1,mouseY=-1,mouseXRel=-1,mouseYRel=-1,progress=0,progressLast=0,tweenFactor=0,tweenLength=850,tweenCurvature=13,tweenMax=1/(1+Math.exp(-tweenCurvature/2)),tweenFrames=0,fpsDisplay=document.getElementById("frameRate"),attributes=[],currentDataset=0,lastDataset=0,datasets=1,datasetSelectSize=30,datasetAlpha=new Tween(0,0),datasetWidths=[],datasetSelectWidth=50;function backingScale(){return"devicePixelRatio"in window&&window.devicePixelRatio>1?window.devicePixelRatio:1}function resize(){if(imageWidth=window.innerWidth,imageHeight=window.innerHeight,snapshotMode||(context.canvas.width=imageWidth*backingScale(),context.canvas.height=imageHeight*backingScale(),context.canvas.style.width=imageWidth+"px",context.canvas.style.height=imageHeight+"px",context.scale(backingScale(),backingScale())),datasetDropDown){var e=2*(datasetDropDown.offsetTop+datasetDropDown.clientHeight)/imageHeight;e>1&&(e=1),e=Math.sqrt(e),datasetSelectWidth=(datasetDropDown.offsetLeft+datasetDropDown.clientWidth)*e}var t=datasets>1?datasetSelectWidth+30:0,a=imageWidth-mapWidth-t>imageHeight?imageHeight:imageWidth-mapWidth-t;maxMapRadius=.03*a,margin=.015*a,centerX=(imageWidth-mapWidth-t)/2+t,centerY=imageHeight/2,gRadius=a/2-(buffer=a*bufferFactor)}function handleResize(){updateViewNeeded=!0}function Attribute(){}function Tween(e,t){this.start=e,this.end=t,this.current=this.start,this.current=function(){return 1==progress||this.start==this.end?this.end:this.start+tweenFactor*(this.end-this.start)},this.setTarget=function(e){this.start=this.current(),this.end=e}}function Node(){this.id=currentNodeID,currentNodeID++,nodes[this.id]=this,this.angleStart=new Tween(Math.PI,0),this.angleEnd=new Tween(Math.PI,0),this.radiusInner=new Tween(1,1),this.labelRadius=new Tween(1,1),this.labelWidth=new Tween(0,0),this.scale=new Tween(1,1),this.radiusOuter=new Tween(1,1),this.r=new Tween(255,255),this.g=new Tween(255,255),this.b=new Tween(255,255),this.alphaLabel=new Tween(0,1),this.alphaLine=new Tween(0,1),this.alphaArc=new Tween(0,0),this.alphaWedge=new Tween(0,1),this.alphaOther=new Tween(0,1),this.alphaPattern=new Tween(0,0),this.children=Array(),this.parent=0,this.attributes=new Array(attributes.length),this.addChild=function(e){this.children.push(e)},this.addLabelNode=function(e,t){0==labelHeadNodes[e][t]&&(labelHeadNodes[e][t]=this,this.labelPrev=this);var a=labelHeadNodes[e][t];this.labelNext=a,this.labelPrev=a.labelPrev,a.labelPrev.labelNext=this,a.labelPrev=this},this.canDisplayDepth=function(){return this.depth<=maxAbsoluteDepth},this.canDisplayHistory=function(){var e;return e=compress?compressedRadii[0]:nodeRadius,-this.labelRadius.end*gRadius+historySpacingFactor*fontSize/2<e*gRadius},this.canDisplayLabelCurrent=function(){return(this.angleEnd.current()-this.angleStart.current())*(this.radiusInner.current()*gRadius+gRadius)>=minWidth()},this.checkHighlight=function(){if(this.children.length,this.hide)return!1;if(1==this.radiusInner.end)return!1;for(var e=!1,t=this.angleStart.current()+rotationOffset,a=this.angleEnd.current()+rotationOffset,i=this.radiusInner.current()*gRadius,s=0;s<this.children.length;s++)if(e=this.children[s].checkHighlight())return!0;if(this.radial){var n=(t+a)/2,o=(gRadius+i)/2;if(context.rotate(n),context.beginPath(),context.moveTo(o,-fontSize),context.lineTo(o,fontSize),context.lineTo(o+centerX,fontSize),context.lineTo(o+centerX,-fontSize),context.closePath(),context.rotate(-n),context.isPointInPath(mouseXRel,mouseYRel)){var r=String(this.getPercentage())+"%   "+this.name;this.searchResultChildren()&&(r+=searchResultString(this.searchResultChildren())),Math.sqrt(mouseXRel*mouseXRel+mouseYRel*mouseYRel)/backingScale()<o+measureText(r)&&(e=!0)}}else for(s=0;s<this.hiddenLabels.length;s++){var h=this.hiddenLabels[s];if(context.rotate(h.angle),context.beginPath(),context.moveTo(gRadius,-fontSize),context.lineTo(gRadius,fontSize),context.lineTo(gRadius+centerX,fontSize),context.lineTo(gRadius+centerX,-fontSize),context.closePath(),context.rotate(-h.angle),context.isPointInPath(mouseXRel,mouseYRel)&&(r=String(h.value)+" more",h.search&&(r+=searchResultString(h.search)),Math.sqrt(mouseXRel*mouseXRel+mouseYRel*mouseYRel)/backingScale()<gRadius+fontSize+measureText(r))){e=!0;break}}return e||this==selectedNode||this.getCollapse()||(context.beginPath(),context.arc(0,0,i,t,a,!1),context.arc(0,0,gRadius,a,t,!0),context.closePath(),context.isPointInPath(mouseXRel,mouseYRel)&&(e=!0),!e&&(a-t)*(i+gRadius)<minWidth()&&this.getDepth()==selectedNode.getDepth()+1&&showKeys&&this.checkHighlightKey()&&(e=!0)),e&&(highlightedNode=this),e},this.checkHighlightCenter=function(){if(this.canDisplayHistory()){var e=centerX,t=centerY-this.labelRadius.end*gRadius,a=this.nameWidth;if(this.searchResultChildren()){var i=searchResultString(this.searchResultChildren());a+=context.measureText(i).width}mouseX>e-a/2&&mouseX<e+a/2&&mouseY>t-historySpacingFactor*fontSize/2&&mouseY<t+historySpacingFactor*fontSize/2?highlightedNode=this:this.getParent()&&this.getParent().checkHighlightCenter()}},this.checkHighlightKey=function(){var e=keyOffset(),t=imageWidth-keySize-margin-this.keyNameWidth-keyBuffer;return currentKey++,mouseX>t&&mouseX<imageWidth-margin&&mouseY>e&&mouseY<e+keySize},this.checkHighlightMap=function(){if(this.parent&&this.parent.checkHighlightMap(),!this.getCollapse()&&this!=focusNode){var e=this.getMapPosition();mouseX>e.x-mapRadius&&mouseX<e.x+mapRadius&&mouseY>e.y-mapRadius&&mouseY<e.y+mapRadius&&(highlightedNode=this)}},this.draw=function(e,t,a){var i=this.getDepth()-selectedNode.getDepth()+1;selectedNode==this&&(t=!0);var s=this.angleStart.current()+rotationOffset,n=this.angleEnd.current()+rotationOffset,o=this.radiusInner.current()*gRadius,r=(this.canDisplayLabelCurrent(),(!this.hide||!this.hidePrev&&progress<1)&&(!this.hideAlone||!this.hideAlonePrev&&progress<1)),h=s;if(this.hasChildren()&&(h=this.children[this.children.length-1].angleEnd.current()+rotationOffset),e){var l=!(this.parent&&this.parent!=selectedNode&&n==this.parent.angleEnd.current()+rotationOffset);this.drawLines(s,n,o,l,t);var d,c=this.alphaOther.current();if((this==selectedNode||c)&&(d=this.children.length?this.children[this.children.length-1].radiusInner.current()*gRadius:o),this==selectedNode&&this.drawReferenceRings(d),t&&!a&&this!=selectedNode&&(this.isSearchResult||this.hideAlone&&this.searchResultChildren())){if(context.globalAlpha=this.alphaWedge.current(),drawWedge(s,n,o,gRadius,highlightFill,0,!0),this.keyed&&!showKeys&&this.searchResults&&!a&&this!=highlightedNode&&this!=focusNode){var u=(n+s)/2;this.drawLabel(u,!0,!1,!0,!0)}a=!0}(this==selectedNode||this!=highlightedNode&&this!=focusNode)&&(this.radial!=this.radialPrev&&1==this.alphaLabel.end?context.globalAlpha=tweenFactor:context.globalAlpha=this.alphaLabel.current(),this.drawLabel((s+n)/2,this.hideAlone&&this.searchResultChildren()||!!this.isSearchResult&&t,this==selectedNode&&!this.radial,t,this.radial),this.radial!=this.radialPrev&&1==this.alphaLabel.start&&progress<1&&(context.globalAlpha=1-tweenFactor,this.drawLabel((s+n)/2,!!this.isSearchResult&&t,this==selectedNodeLast&&!this.radialPrev,t,this.radialPrev))),c&&null!=h&&(n-h)*(d+gRadius)>=minWidth()&&(context.globalAlpha=this.alphaOther.current(),drawTextPolar(this.getUnclassifiedText(),this.getUnclassifiedPercentage(),(h+n)/2,(d+gRadius)/2,!0,!1,!1,0,0)),this==selectedNode&&this.keyUnclassified&&showKeys&&this.drawKey((h+n)/2,!1,!1)}else{var g=this.alphaWedge.current();if(g||this.alphaOther.current()){var p,f=rgbText(this.r.current(),this.g.current(),this.b.current()),m=(this.hasChildren()||this==selectedNode)&&!this.keyed&&(compress||i<maxDisplayDepth)&&r;p=m?this.children.length?this.children[0].radiusInner.current()*gRadius:o:gRadius,context.globalAlpha=g,(o!=p||m)&&(drawWedge(s,n,o,p,f,this.alphaPattern.current()),m&&h<n&&(g<1&&(context.globalAlpha=this.alphaOther.current(),drawWedge(h,n,p,gRadius,colorUnclassified,0),context.globalAlpha=g),drawWedge(h,n,p,gRadius,f,this.alphaPattern.current())),p<gRadius&&(context.beginPath(),context.arc(0,0,p,s,n,!1),context.strokeStyle=f,context.lineWidth=1,context.stroke())),this.keyed&&t&&showKeys&&this.drawKey((s+n)/2,this==highlightedNode||this==focusNode||this.searchResults,this==highlightedNode||this==focusNode)}}if(this.hiddenLabels=Array(),r)for(var b=0;b<this.children.length;b++)this.drawHiddenChildren(b,t,e,a)?b=this.children[b].hiddenEnd:this.children[b].draw(e,t,a)},this.drawHiddenChildren=function(e,t,a,i){var s=this.children[e];if(null==s.hiddenEnd||1==s.radiusInner.current())return!1;for(var n=e;n<s.hiddenEnd;n++)if(!this.children[n].hide||!this.children[n].hidePrev&&progress<1)return!1;var o=s.angleStart.current()+rotationOffset,r=this.children[s.hiddenEnd].angleEnd.current()+rotationOffset,h=gRadius*s.radiusInner.current(),l=s.hiddenEnd-e+1;if(a){var d=0;for(n=e;n<=s.hiddenEnd;n++)d+=this.children[n].searchResults,0==this.children[n].magnitude&&l--;(t&&(r-o)*(gRadius+gRadius)>=minWidth()||this==highlightedNode&&l||d)&&(context.globalAlpha=this.alphaWedge.current(),this.drawHiddenLabel(o,r,l,d))}var c=!0;for(n=e;n<=s.hiddenEnd;n++)if(this.children[n].alphaPattern.current()!=this.children[n].alphaWedge.current()){c=!1;break}if(a){if(c){var u=r<this.angleEnd.current()+rotationOffset;this.drawLines(o,r,h,u)}d&&!i&&drawWedge(o,r,h,gRadius,highlightFill,0,!0)}else if(c){context.globalAlpha=this.alphaWedge.current();var g=rgbText(s.r.current(),s.g.current(),s.b.current());drawWedge(o,r,h,gRadius,g,context.globalAlpha,!1)}return c},this.drawHiddenLabel=function(e,t,a,i){var s=(e+t)/2,n=gRadius+fontSize,o=Array();o.value=a,o.angle=s,o.search=i,this.hiddenLabels.push(o),drawTick(gRadius-.75*fontSize,1.5*fontSize,s),drawTextPolar(a.toString()+" more",0,s,n,!0,i,this==highlightedNode||this==focusNode,!1,i)},this.drawHighlight=function(e){var t=this.angleStart.current()+rotationOffset,a=this.angleEnd.current()+rotationOffset,i=this.radiusInner.current()*gRadius;this==focusNode&&this==highlightedNode&&this.hasChildren()?arrow(t,a,i):drawWedge(t,a,i,gRadius,highlightFill,0,!0);for(var s=0;s<this.children.length;s++)if(this.children[s].getDepth()-selectedNode.getDepth()+1<=maxDisplayDepth&&null!=this.children[s].hiddenEnd){var n=this.children[s],o=this.children[n.hiddenEnd];drawWedge(n.angleStart.current()+rotationOffset,o.angleEnd.current()+rotationOffset,gRadius*n.radiusInner.current(),gRadius,"rgba(255, 255, 255, .3)",0,!0),s=n.hiddenEnd}context.fillStyle="black";var r=(a+t)/2;this.keyed&&showKeys||this.drawLabel(r,!0,e,!0,this.radial)},this.drawHighlightCenter=function(){this.canDisplayHistory()&&(context.lineWidth=highlightLineWidth,context.strokeStyle="black",context.fillStyle="rgba(255, 255, 255, .6)",context.fillStyle="black",this.drawLabel(3*Math.PI/2,!0,!0,!1),context.font=fontNormal)},this.drawKey=function(e,t,a){var i,s,n,o=keyOffset(),r=0==this.magnitude?"gray":"black",h=this.alphaPattern.end,l=imageWidth-keySize-margin,d=o+keySize/2;this==selectedNode?(i=colorUnclassified,n=measureText(s=this.getUnclassifiedText()+"   "+this.getUnclassifiedPercentage(),!1)):(s=this.keyLabel,i=rgbText(this.r.end,this.g.end,this.b.end),t?(this.searchResultChildren()&&(s+=searchResultString(this.searchResultChildren())),n=measureText(s,a)):n=this.keyNameWidth);var c=l-keyBuffer-n-fontSize/2,u=c;u>keyMinTextLeft-fontSize/2&&((keyMinTextLeft-=fontSize/2)<centerX-gRadius+fontSize/2&&(keyMinTextLeft=centerX-gRadius+fontSize/2),u=keyMinTextLeft);var g,p,f=[],m=[],b=Math.atan((d-centerY)/(u-centerX));if(b<0&&(b+=Math.PI),(0==keyMinAngle||e<keyMinAngle)&&(keyMinAngle=e),e>Math.PI&&keyMinAngle>Math.PI&&(e-=2*Math.PI),f.push(Math.cos(e)*gRadius),m.push(Math.sin(e)*gRadius),g=e<b&&d>centerY+Math.sin(e)*(gRadius+buffer*(currentKey-1)/(keys+1)/2+buffer/2)?gRadius+buffer-buffer*currentKey/(keys+1)/2:gRadius+buffer*currentKey/(keys+1)/2+buffer/2,Math.sqrt(Math.pow(u-centerX,2)+Math.pow(d-centerY,2))>g?(keyMinTextLeft=min(keyMinTextLeft,u-fontSize/2),p=e<b?Math.PI/2-keyLineAngle(Math.PI/2-e,Math.PI/2-b,g,d-centerY,u-centerX,m,f):keyLineAngle(e,b,g,u-centerX,d-centerY,f,m)):(p=Math.asin((d-centerY)/g),keyMinTextLeft=min(keyMinTextLeft,centerX+g*Math.cos(p)-fontSize/2),u<c&&c>centerX+g*Math.cos(p)&&(f.push(c-centerX),m.push(d-centerY))),(u>centerX+g*Math.cos(p)||d>centerY+g*Math.sin(p)+.01)&&(f.push(u-centerX),m.push(d-centerY),c!=u&&(f.push(c-centerX),m.push(d-centerY))),context.globalAlpha=this.alphaWedge.current(),snapshotMode){var x;x=this==selectedNode?this.getUnclassifiedText()+spacer()+this.getUnclassifiedPercentage():this.name+spacer()+this.getPercentage()+"%",svg+='<rect fill="'+i+'" x="'+l+'" y="'+o+'" width="'+keySize+'" height="'+keySize+'"/>',h&&(svg+='<rect fill="url(#hiddenPattern)" style="stroke:none" x="'+l+'" y="'+o+'" width="'+keySize+'" height="'+keySize+'"/>'),svg+='<path class="line'+(t?" highlight":"")+'" d="M '+(f[0]+centerX)+","+(m[0]+centerY),e!=p&&(svg+=" L "+(centerX+g*Math.cos(e))+","+(centerY+g*Math.sin(e))+" A "+g+","+g+" 0 0,"+(e>p?"0":"1")+" "+(centerX+g*Math.cos(p))+","+(centerY+g*Math.sin(p)));for(var y=1;y<f.length;y++)svg+=" L "+(centerX+f[y])+","+(centerY+m[y]);svg+='"/>',t&&(this.searchResultChildren()&&(x+=searchResultString(this.searchResultChildren())),drawBubbleSVG(l-keyBuffer-n-fontSize/2,d-fontSize,n+fontSize,2*fontSize,fontSize,0),this.isSearchResult&&drawSearchHighlights(s,l-keyBuffer-n,d,0)),svg+=svgText(x,l-keyBuffer,d,"end",a,r)}else{if(context.fillStyle=i,context.translate(-centerX,-centerY),context.strokeStyle="black",context.globalAlpha=1,context.fillRect(l,o,keySize,keySize),h&&(context.globalAlpha=h,context.fillStyle=hiddenPattern,context.beginPath(),context.moveTo(l,o),context.lineTo(l+keySize,o),context.lineTo(l+keySize,o+keySize),context.lineTo(l,o+keySize),context.closePath(),context.save(),context.clip(),context.fillRect(l,o,keySize,keySize),context.fillRect(l,o,keySize,keySize),context.restore()),t?(this.setHighlightStyle(),context.fillRect(l,o,keySize,keySize)):context.lineWidth=thinLineWidth,context.strokeRect(l,o,keySize,keySize),f.length){for(context.beginPath(),context.moveTo(f[0]+centerX,m[0]+centerY),context.arc(centerX,centerY,g,e,p,e>p),y=1;y<f.length;y++)context.lineTo(f[y]+centerX,m[y]+centerY);context.globalAlpha=this==selectedNode?this.children[0].alphaWedge.current():this.alphaWedge.current(),context.lineWidth=t?highlightLineWidth:thinLineWidth,context.stroke(),context.globalAlpha=1}t&&(drawBubbleCanvas(l-keyBuffer-n-fontSize/2,d-fontSize,n+fontSize,2*fontSize,fontSize,0),this.isSearchResult&&drawSearchHighlights(s,l-keyBuffer-n,d,0)),drawText(s,l-keyBuffer,o+keySize/2,0,"end",a,r),context.translate(centerX,centerY)}currentKey++},this.drawLabel=function(e,t,a,i,s){if(0!=context.globalAlpha){var n,o;o=s?(this.radiusInner.current()+1)*gRadius/2:this.labelRadius.current()*gRadius,s&&(i||t)&&(n=this.getPercentage()+"%");var r=drawTextPolar(s||this==selectedNode||t||zoomOut&&this==selectedNodeLast?this.name:this.shortenLabel(),n,e,o,s,t,a,this.isSearchResult&&(!i||this==selectedNode||t),this.hideAlone||!i||this==selectedNode?this.searchResultChildren():0),h=this.getDepth()-selectedNode.getDepth()+1;if(!s&&!t&&this!=selectedNode&&this.angleEnd.end!=this.angleStart.end&&nLabelOffsets[h-2]>2&&this.labelWidth.current()>(this.angleEnd.end-this.angleStart.end)*Math.abs(o)&&(!zoomOut||this!=selectedNodeLast)&&this.labelRadius.end>0){var l=compress?(compressedRadii[h-1]+compressedRadii[h-2])/2:(h-.5)*nodeRadius;this.labelRadius.end>l?drawTick(r?o-1.4*tickLength:o-1.7*tickLength,tickLength,e):drawTick(r?o+.7*tickLength:o+.4*tickLength,tickLength,e)}}},this.drawLines=function(e,t,a,i,s){if(snapshotMode){if(this!=selectedNode){t==e+2*Math.PI&&(t-=.1/gRadius);var n=t-e>Math.PI?1:0,o=centerX+a*Math.cos(e),r=centerY+a*Math.sin(e),h=centerX+gRadius*Math.cos(e),l=centerY+gRadius*Math.sin(e),d=centerX+gRadius*Math.cos(t),c=centerY+gRadius*Math.sin(t),u=centerX+a*Math.cos(t),g=centerY+a*Math.sin(t);this.alphaArc.end&&(svg+='<path class="line" d="'+[" M ",u,",",g," A ",a,",",a," 0 ",n," 0 ",o,",",r].join("")+'"/>'),i&&this.alphaLine.end&&(svg+='<line x1="'+d+'" y1="'+c+'" x2="'+u+'" y2="'+g+'"/>')}}else context.lineWidth=thinLineWidth,context.strokeStyle="black",context.beginPath(),context.arc(0,0,a,e,t,!1),context.globalAlpha=this.alphaArc.current(),context.stroke(),i&&(o=a*Math.cos(t),r=a*Math.sin(t),h=gRadius*Math.cos(t),l=gRadius*Math.sin(t),context.beginPath(),context.moveTo(o,r),context.lineTo(h,l),context.globalAlpha=this.alphaLine.current(),context.stroke())},this.drawMap=function(e){if(this.parent&&this.parent.drawMap(e),!(this.getCollapse()&&this!=e||this==focusNode)){var t=(e.baseMagnitude-this.baseMagnitude)/this.magnitude*Math.PI*2+rotationOffset,a=(e.baseMagnitude-this.baseMagnitude+e.magnitude)/this.magnitude*Math.PI*2+rotationOffset,i=this.getMapPosition();context.save(),context.fillStyle="black",context.textAlign="end",context.textBaseline="middle";var s=i.x-mapRadius-mapBuffer,n=getPercentage(e.magnitude/this.magnitude),o=this==selectedNode||this==highlightedNode;context.font=o?fontBold:fontNormal,context.fillText(n+"% of",s,i.y-mapRadius/3),context.fillText(this.name,s,i.y+mapRadius/3),o&&(context.font=fontNormal),context.fillStyle=this==highlightedNode&&this!=selectedNode?"rgb(245, 245, 245)":"rgb(255, 255, 255)",context.beginPath(),context.arc(i.x,i.y,mapRadius,0,2*Math.PI,!0),context.closePath(),context.fill(),this==selectedNode?(context.lineWidth=1,context.fillStyle="rgb(100, 100, 100)"):this==highlightedNode?(context.lineWidth=.2,context.fillStyle="rgb(190, 190, 190)"):(context.lineWidth=.2,context.fillStyle="rgb(200, 200, 200)");var r,h=this.getMaxDepth();!compress&&h>maxPossibleDepth+this.getDepth()-1&&(h=maxPossibleDepth+this.getDepth()-1),this.getDepth()<selectedNode.getDepth()&&e.getDepth()-1>=h&&(h=e.getDepth()),r=compress?0:(e.getDepth()-this.getDepth())/(h-this.getDepth()+1),context.stroke(),context.beginPath(),0==r?context.moveTo(i.x,i.y):context.arc(i.x,i.y,mapRadius*r,a,t,!0),context.arc(i.x,i.y,mapRadius,t,a,!1),context.closePath(),context.fill(),this==highlightedNode&&this!=selectedNode&&(context.lineWidth=1,context.stroke()),context.restore()}},this.drawReferenceRings=function(e){snapshotMode?(svg+='<circle cx="'+centerX+'" cy="'+centerY+'" r="'+e+'"/>',svg+='<circle cx="'+centerX+'" cy="'+centerY+'" r="'+gRadius+'"/>'):(context.globalAlpha=1-this.alphaLine.current(),context.beginPath(),context.arc(0,0,e,0,2*Math.PI,!1),context.stroke(),context.beginPath(),context.arc(0,0,gRadius,0,2*Math.PI,!1),context.stroke())},this.getCollapse=function(){return collapse&&this.collapse&&this.depth!=maxAbsoluteDepth},this.getDepth=function(){return collapse?this.depthCollapsed:this.depth},this.getMagnitude=function(){return this.attributes[magnitudeIndex][currentDataset]},this.getMapPosition=function(){return{x:details.offsetLeft+details.clientWidth-mapRadius,y:(focusNode.getDepth()-this.getDepth())*(mapBuffer+2*mapRadius)-mapRadius+details.clientHeight+details.offsetTop}},this.getMaxDepth=function(e){return collapse?this.maxDepthCollapsed:this.maxDepth>maxAbsoluteDepth?maxAbsoluteDepth:this.maxDepth},this.getData=function(e,t){var a=[];if(null!=this.attributes[e]&&null!=this.attributes[e][currentDataset]&&""!=this.attributes[e][currentDataset]&&a.push(document.location+".files/"+this.attributes[e][currentDataset]),t)for(var i=0;i<this.children.length;i++)a=a.concat(this.children[i].getData(e,!0));return a},this.getList=function(e,t){var a;if(a=null!=this.attributes[e]&&null!=this.attributes[e][currentDataset]?this.attributes[e][currentDataset]:[],t)for(var i=0;i<this.children.length;i++)a=a.concat(this.children[i].getList(e,!0));return a},this.getParent=function(){for(var e=this.parent;0!=e&&e.getCollapse();)e=e.parent;return e},this.getPercentage=function(){return getPercentage(this.magnitude/selectedNode.magnitude)},this.getUnclassifiedPercentage=function(){if(this.children.length){var e=this.children[this.children.length-1];return getPercentage((this.baseMagnitude+this.magnitude-e.magnitude-e.baseMagnitude)/this.magnitude)+"%"}return"100%"},this.getUnclassifiedText=function(){return"[other "+this.name+"]"},this.getUncollapsed=function(){return this.getCollapse()?this.children[0].getUncollapsed():this},this.hasChildren=function(){return this.children.length&&this.depth<maxAbsoluteDepth&&this.magnitude},this.hasParent=function(e){return!!this.parent&&(this.parent==e||this.parent.hasParent(e))},this.maxVisibleDepth=function(e){var t,a=this.getDepth()-selectedNode.getDepth()+1,i=a;if(this.hasChildren()&&a<e){var s=this.children[this.children.length-1];this.name,s.baseMagnitude+s.magnitude<this.baseMagnitude+this.magnitude&&i++,t=compress?compressedRadii[a-1]:a/e;for(var n=0;n<this.children.length;n++)if(this.children[n].magnitude*angleFactor*(t+1)*gRadius>=minWidth()){var o=this.children[n].maxVisibleDepth(e);o>i&&(i=o)}}return i},this.resetLabelWidth=function(){var e=this.nameWidth,t=context.measureText(this.name);this.nameWidth=t.width,fontSize!=fontSizeLast&&this.labelWidth.end==e*labelWidthFudge?this.labelWidth.start=this.nameWidth*labelWidthFudge:this.labelWidth.start=this.labelWidth.current(),this.labelWidth.end=this.nameWidth*labelWidthFudge},this.restrictLabelWidth=function(e){e<this.labelWidth.end&&(this.labelWidth.end=e)},this.search=function(){this.isSearchResult=!1,this.searchResults=0,this.getCollapse()||""==search.value||-1==this.name.toLowerCase().indexOf(search.value.toLowerCase())||(this.isSearchResult=!0,this.searchResults=1,nSearchResults++);for(var e=0;e<this.children.length;e++)this.searchResults+=this.children[e].search();return this.searchResults},this.searchResultChildren=function(){return this.isSearchResult?this.searchResults-1:this.searchResults},this.setDepth=function(e,t){this.depth=e,this.depthCollapsed=t,1==this.children.length&&this.children[0].magnitude==this.magnitude&&(head.children.length>1||this.children[0].children.length)?this.collapse=!0:(this.collapse=!1,t++);for(var a=0;a<this.children.length;a++)this.children[a].setDepth(e+1,t)},this.setHighlightStyle=function(){context.lineWidth=highlightLineWidth,this.hasChildren()||this!=focusNode||this!=highlightedNode?(context.strokeStyle="black",context.fillStyle="rgba(255, 255, 255, .3)"):(context.strokeStyle="rgb(90,90,90)",context.fillStyle="rgba(155, 155, 155, .3)")},this.setLabelWidth=function(e){if(shorten&&!this.radial)if(e.hide)alert("wtf");else{var t,a,i=(this.angleStart.end+this.angleEnd.end)/2;if(0!=(t=e==selectedNode?Math.abs(i-e.angleOther):Math.abs(i-(e.angleStart.end+e.angleEnd.end)/2)))if(t>Math.PI&&(t=2*Math.PI-t),e.radial||e==selectedNode){if(a=e==selectedNode?(e.children[0].radiusInner.end+1)/2:(e.radiusInner.end+1)/2,t<Math.PI/2){var s=this.labelRadius.end*gRadius+.5*fontSize,n=s/Math.cos(t),o=s*Math.tan(t),r=.8*fontSize;a*gRadius<n&&this.labelWidth.end/2+r>o&&(this.labelWidth.end=2*(o-r))}}else if(this.labelRadius.end==e.labelRadius.end&&t<Math.PI/4){var h=t*this.labelRadius.end*gRadius-fontSize*(1-4*t/Math.PI)*1.3;this.labelWidth.end<h?e.restrictLabelWidth(2*(h-this.labelWidth.end/2)):e.labelWidth.end<h?this.restrictLabelWidth(2*(h-e.labelWidth.end/2)):(this.labelWidth.end=h,e.labelWidth.end=h)}else{var l=this.labelRadius.end*gRadius,d=e.labelRadius.end*gRadius,c=.35*fontSize;this.labelRadius.end<e.labelRadius.end?(l+=c,d-=c):this.labelRadius.end>e.labelRadius.end?(l-=c,d+=c):(l-=c,d-=c);var u=l*l,g=d*d,p=(h=Math.sqrt(u+g-2*l*d*Math.cos(t)),Math.acos((u+h*h-g)/(2*l*h))),f=Math.sin(t+p-Math.PI/2)*h/Math.sin(Math.PI-t),m=Math.sin(Math.PI/2-p)*h/Math.sin(Math.PI-t);f=Math.abs(f)-.4*fontSize,m=Math.abs(m)-.4*fontSize,this.labelWidth.end/2>f&&e.labelWidth.end/2>m&&(f>m?this.restrictLabelWidth(2*f):e.restrictLabelWidth(2*m))}}},this.setMagnitudes=function(e){this.magnitude=this.getMagnitude(),this.baseMagnitude=e;for(var t=0;t<this.children.length;t++)this.children[t].setMagnitudes(e),e+=this.children[t].magnitude;this.maxChildMagnitude=e},this.setMaxDepths=function(){let e;for(e in this.maxDepth=this.depth,this.maxDepthCollapsed=this.depthCollapsed,this.children){var t=this.children[e];t.setMaxDepths(),t.maxDepth>this.maxDepth&&(this.maxDepth=t.maxDepth),t.maxDepthCollapsed>this.maxDepthCollapsed&&(t.depth<=maxAbsoluteDepth||0==maxAbsoluteDepth)&&(this.maxDepthCollapsed=t.maxDepthCollapsed)}},this.setTargetLabelRadius=function(){var e=this.getDepth()-selectedNode.getDepth()+1,t=e-2,a=labelOffsets[t];if(this.radial){var i=e==maxDisplayDepth?1:compressedRadii[t+1];this.labelRadius.setTarget((compressedRadii[t]+i)/2)}else{var s,n;compress?nLabelOffsets[t]>1?this.labelRadius.setTarget(lerp(a+.75,0,nLabelOffsets[t]+.5,compressedRadii[t],compressedRadii[t+1])):this.labelRadius.setTarget((compressedRadii[t]+compressedRadii[t+1])/2):(s=nodeRadius*(e-1)+nodeRadius/2,n=nodeRadius,this.labelRadius.setTarget(s+n*((a+1)/(nLabelOffsets[t]+1)-.5)))}if(this.hide||this.keyed||!nLabelOffsets[t])this.hide&&(this.labelWidth.end=0);else{for(var o=0;o<maxDisplayDepth-1;o++)for(var r=0;r<=nLabelOffsets[o];r++){var h=labelLastNodes[o][r],l=labelFirstNodes[o][r];h&&(r==nLabelOffsets[o]?this.setLabelWidth(h):h.setLabelWidth(this)),l&&(r==nLabelOffsets[o]?this.setLabelWidth(l):l.setLabelWidth(this))}selectedNode.canDisplayLabelOther&&this.setLabelWidth(selectedNode),this.radial?(labelLastNodes[t][nLabelOffsets[t]]=this,0==labelFirstNodes[t][nLabelOffsets[t]]&&(labelFirstNodes[t][nLabelOffsets[t]]=this)):(labelLastNodes[t][a]=this,labelOffsets[t]+=1,labelOffsets[t]>nLabelOffsets[t]?(labelOffsets[t]-=nLabelOffsets[t],1&nLabelOffsets[t]||labelOffsets[t]--):labelOffsets[t]==nLabelOffsets[t]&&(labelOffsets[t]-=nLabelOffsets[t]),0==labelFirstNodes[t][a]&&(labelFirstNodes[t][a]=this))}},this.setTargets=function(){if(this!=selectedNode){var e=this.getDepth()-selectedNode.getDepth(),t=selectedNode.hasParent(this);if(t)this.resetLabelWidth();else{var a=context.measureText(this.name);this.nameWidth=a.width,this.labelWidth.setTarget(0)}this.baseMagnitude<=selectedNode.baseMagnitude?this.angleStart.setTarget(0):this.angleStart.setTarget(2*Math.PI),t||this.baseMagnitude+this.magnitude>=selectedNode.baseMagnitude+selectedNode.magnitude?this.angleEnd.setTarget(2*Math.PI):this.angleEnd.setTarget(0);for(var i=0;i<this.children.length;i++)this.children[i].setTargets();if(this.getDepth()<=selectedNode.getDepth()?(this.radiusInner.setTarget(0),t?this.labelRadius.setTarget(e*historySpacingFactor*fontSize/gRadius):this.labelRadius.setTarget(0)):e+1>maxDisplayDepth?(this.radiusInner.setTarget(1),this.labelRadius.setTarget(1)):(compress?this.radiusInner.setTarget(compressedRadii[e-1]):this.radiusInner.setTarget(nodeRadius*e),this==selectedNode?this.labelRadius.setTarget(0):compress?this.labelRadius.setTarget((compressedRadii[e-1]+compressedRadii[e])/2):this.labelRadius.setTarget(nodeRadius*e+nodeRadius/2)),this.r.setTarget(255),this.g.setTarget(255),this.b.setTarget(255),this.alphaLine.setTarget(0),this.alphaArc.setTarget(0),this.alphaWedge.setTarget(0),this.alphaPattern.setTarget(0),this.alphaOther.setTarget(0),t&&!this.getCollapse()){var s=1-(selectedNode.getDepth()-this.getDepth())/(Math.floor((compress?compressedRadii[0]:nodeRadius)*gRadius/(historySpacingFactor*fontSize)-.5)+1);s<0&&(s=0),this.alphaLabel.setTarget(s),this.radial=!1}else this.alphaLabel.setTarget(0);this.hideAlonePrev=this.hideAlone,this.hidePrev=this.hide,t&&(this.hideAlone=!1,this.hide=!1),this.getParent()==selectedNode.getParent()&&(this.hiddenEnd=null),this.radialPrev=this.radial}else this.setTargetsSelected(0,1,lightnessBase,!1,!1)},this.setTargetsSelected=function(e,t,a,i,s){var n=this.getCollapse(),o=this.getDepth()-selectedNode.getDepth()+1;this.hasChildren()?(b=this.children[this.children.length-1],this.hideAlone=!0):this.hideAlone=!1;for(var r=0;r<this.children.length;r++)this.children[r].setTargetWedge(),!this.children[r].hide&&(n||o<maxDisplayDepth)&&this.depth<maxAbsoluteDepth&&(this.hideAlone=!1);if((this==selectedNode||b&&b.angleEnd.end<this.angleEnd.end-.01)&&(this.hideAlone=!1),null==this.hideAlonePrev&&(this.hideAlonePrev=this.hideAlone),this==selectedNode){var h=this.children.length?angleFactor*(this.baseMagnitude+this.magnitude-b.baseMagnitude-b.magnitude):this.baseMagnitude+this.magnitude;this.canDisplayLabelOther=!this.children.length||h*(this.children[0].radiusInner.end+1)*gRadius>=minWidth(),this.keyUnclassified=!1,this.canDisplayLabelOther?this.angleOther=2*Math.PI-h/2:h>1e-10&&(this.keyUnclassified=!0,keys++),this.angleStart.setTarget(0),this.angleEnd.setTarget(2*Math.PI),this.children.length?this.radiusInner.setTarget(0):this.radiusInner.setTarget(compressedRadii[0]),this.hidePrev=this.hide,this.hide=!1,this.hideAlonePrev=this.hideAlone,this.hideAlone=!1,this.keyed=!1}t-e>1/12&&(t=e+1/12),i||this.hideAlone||(useHue()?a=(lightnessBase+lightnessMax)/2:(a=lightnessBase+(o-1)*lightnessFactor)>lightnessMax&&(a=lightnessMax)),i&&(this.hide=!0),null==this.hidePrev&&(this.hidePrev=this.hide);var l=-1,d=0,c=0;for(r=0,this.hide||(this.hiddenEnd=null);;){if(!(this.hideAlone||i||r!=this.children.length&&this.children[r].hide)&&-1!=l){for(var u=c?d/c:e,g=l;g<r;g++)this.children[g].setTargetsSelected(u,null,a,!1,g<r-1),this.children[g].hiddenEnd=null;this.children[l].hiddenEnd=r-1}if(r==this.children.length)break;var p,f,m=this.children[r];this.magnitude>0&&!this.hide&&!this.hideAlone?useHue()?p=m.hues[currentDataset]:this==selectedNode?this.children.length>6?(p=lerp(.95*(1-Math.pow(1-r/this.children.length,1.4)),0,1,0,1),f=lerp(.95*(1-Math.pow(1-(r+.55)/this.children.length,1.4)),0,1,0,1)):(p=lerp(r/this.children.length,0,1,0,1),f=lerp((r+.55)/this.children.length,0,1,0,1)):(p=lerp(m.baseMagnitude,this.baseMagnitude,this.baseMagnitude+this.magnitude,e,t),f=lerp(m.baseMagnitude+.99*m.magnitude,this.baseMagnitude,this.baseMagnitude+this.magnitude,e,t)):(p=e,f=t),this.hideAlone||i||this.hide||!m.hide?(l=-1,this.children[r].setTargetsSelected(p,f,a,i||this.keyed||this.hideAlone||this.hide&&!n,!1)):(-1==l&&(l=r),useHue()?(d+=p*m.magnitude,c+=m.magnitude):(d+=p,c++)),r++}if(this.hue&&this.magnitude&&(this.hue.setTarget(this.hues[currentDataset]),0==this.attributes[magnitudeIndex][lastDataset]&&(this.hue.start=this.hue.end)),this.radialPrev=this.radial,this==selectedNode)this.resetLabelWidth(),this.labelWidth.setTarget(this.nameWidth*labelWidthFudge),this.alphaWedge.setTarget(0),this.alphaLabel.setTarget(1),this.alphaOther.setTarget(1),this.alphaArc.setTarget(0),this.alphaLine.setTarget(0),this.alphaPattern.setTarget(0),this.r.setTarget(255),this.g.setTarget(255),this.b.setTarget(255),this.radial=!1,this.labelRadius.setTarget(0);else{var b,x=hslToRgb(e,saturation,a);this.r.setTarget(x.r),this.g.setTarget(x.g),this.b.setTarget(x.b),this.alphaOther.setTarget(0),this.alphaWedge.setTarget(1),this.hide||this.hideAlone?this.alphaPattern.setTarget(1):this.alphaPattern.setTarget(0),i||this.hide||(this.hideAlone?this.radial=!0:(this.radial=!0,this.hasChildren()&&o<maxDisplayDepth&&((b=this.children[this.children.length-1]).angleEnd.end==this.angleEnd.end||((this.angleStart.end+this.angleEnd.end)/2-b.angleEnd.end)*(this.radiusInner.end+1)*gRadius*2<minWidth())&&(this.radial=!1))),n||i||this.hide||this.keyed||o>maxDisplayDepth||!this.canDisplayDepth()?this.alphaLabel.setTarget(0):this.radial||nLabelOffsets[o-2]?this.alphaLabel.setTarget(1):(this.alphaLabel.setTarget(0),this.radialPrev&&(this.alphaLabel.start=0)),n||i||o>maxDisplayDepth||!this.canDisplayDepth()?this.alphaArc.setTarget(0):this.alphaArc.setTarget(1),i||this.hide&&s||o>maxDisplayDepth||!this.canDisplayDepth()?this.alphaLine.setTarget(0):this.alphaLine.setTarget(1),this.resetLabelWidth(),n?this.labelRadius.setTarget(this.radiusInner.end):o>maxDisplayDepth||!this.canDisplayDepth()?this.labelRadius.setTarget(1):this.setTargetLabelRadius()}},this.setTargetWedge=function(){var e=this.getDepth()-selectedNode.getDepth()+1,t=this.baseMagnitude-selectedNode.baseMagnitude;if(this.angleStart.setTarget(t*angleFactor),this.angleEnd.setTarget((t+this.magnitude)*angleFactor),e>maxDisplayDepth||!this.canDisplayDepth()?this.radiusInner.setTarget(1):compress?this.radiusInner.setTarget(compressedRadii[e-2]):this.radiusInner.setTarget(nodeRadius*(e-1)),null!=this.hide&&(this.hidePrev=this.hide),null!=this.hideAlone&&(this.hideAlonePrev=this.hideAlone),(this.angleEnd.end-this.angleStart.end)*(this.radiusInner.end*gRadius+gRadius)<minWidth())if(2==e&&!this.getCollapse()&&this.depth<=maxAbsoluteDepth){this.keyed=!0,keys++,this.hide=!1;var a=this.getPercentage();this.keyLabel=this.name+"   "+a+"%";var i=context.measureText(this.keyLabel);this.keyNameWidth=i.width}else this.keyed=!1,this.hide=e>2;else this.keyed=!1,this.hide=!1},this.shortenLabel=function(){var e=this.name,t=this.nameWidth,a=this.labelWidth.current();if(t>a&&e.length>0){var i=Math.floor((e.length-1)*a/t/2);return i<0&&(i=0),e.substring(0,i)+"..."+e.substring(e.length-i)}return e},this.sort=function(){this.children.sort((function(e,t){return t.getMagnitude()-e.getMagnitude()}));for(var e=0;e<this.children.length;e++)this.children[e].sort()}}function addOptionElement(e,t,a){var i=document.createElement("div");return i.innerHTML=t,i.style.padding="2px",a&&(i.title=a),options.appendChild(i),e+0}function addOptionElements(e,t){(options=document.createElement("div")).style.position="absolute",options.style.top="0px",options.addEventListener("mousedown",(function(e){mouseClick(e)}),!1),document.body.appendChild(options),document.body.style.font="11px sans-serif";var a=5;(details=document.createElement("div")).style.position="absolute",details.style.top="1%",details.style.right="2%",details.style.textAlign="right",document.body.insertBefore(details,canvas),details.innerHTML='<span id="detailsName" style="font-weight:bold"></span>&nbsp;<input type="button" id="detailsExpand" onclick="expand(focusNode);"value="&harr;" title="Expand this wedge to become the new focus of the chart"/><br/><div id="detailsInfo" style="float:right"></div>',(keyControl=document.createElement("input")).type="button",keyControl.value=showKeys?"x":"…",keyControl.style.position="",keyControl.style.position="fixed",keyControl.style.visibility="hidden",document.body.insertBefore(keyControl,canvas);var i=document.getElementById("logo");if(a=addOptionElement(a,'<a style="margin:2px" target="_blank" href="https://github.com/marbl/Krona/wiki"><img style="vertical-align:middle;width:108px;height:30px;" src="'+(logoImage=i?i.src:"http://marbl.github.io/Krona/img/logo-med.png")+'" alt="Logo of Krona"/></a><input type="button" id="back" value="&larr;" title="Go back (Shortcut: &larr;)"/><input type="button" id="forward" value="&rarr;" title="Go forward (Shortcut: &rarr;)"/> &nbsp;Search: <input type="text" id="search"/><input id="searchClear" type="button" value="x" onclick="clearSearch()"/> <span id="searchResults"></span>'),datasets>1){for(var s='<table style="border-collapse:collapse;padding:0px"><tr><td style="padding:0px"><select id="datasets" style="min-width:100px" size="'+(datasets<datasetSelectSize?datasets:datasetSelectSize)+'" onchange="onDatasetChange()">',n=0;n<datasetNames.length;n++)s+="<option>"+datasetNames[n]+"</option>";a=addOptionElement(a+5,s+='</select></td><td style="vertical-align:top;padding:1px;"><input style="display:block" title="Previous dataset (Shortcut: &uarr;)" id="prevDataset" type="button" value="&uarr;" onclick="prevDataset()" disabled="true"/><input title="Next dataset (Shortcut: &darr;)" id="nextDataset" type="button" value="&darr;" onclick="nextDataset()"/><br/></td><td style="padding-top:1px;vertical-align:top"><input title="Switch to the last dataset that was viewed (Shortcut: TAB)" id="lastDataset" type="button" style="font:11px Times new roman" value="last" onclick="selectLastDataset()"/></td></tr></table>'),datasetDropDown=document.getElementById("datasets"),datasetButtonLast=document.getElementById("lastDataset"),datasetButtonPrev=document.getElementById("prevDataset"),datasetButtonNext=document.getElementById("nextDataset"),a+=datasetDropDown.clientHeight}a=addOptionElement(a+5,'<input type="button" id="maxAbsoluteDepthDecrease" value="-"/><span id="maxAbsoluteDepth"></span>&nbsp;<input type="button" id="maxAbsoluteDepthIncrease" value="+"/> Max depth',"Maximum depth to display, counted from the top level and including collapsed wedges."),a=addOptionElement(a,'<input type="button" id="fontSizeDecrease" value="-"/><span id="fontSize"></span>&nbsp;<input type="button" id="fontSizeIncrease" value="+"/> Font size'),a=addOptionElement(a,'<input type="button" id="radiusDecrease" value="-"/><input type="button" id="radiusIncrease" value="+"/> Chart size'),e&&(a=addOptionElement(a+5,'<input type="checkbox" id="useHue" style="float:left" /><div>Color by<br/>'+(hueDisplayName=attributes[attributeIndex(e)].displayName)+"</div>"),(useHueCheckBox=document.getElementById("useHue")).checked=t,useHueCheckBox.onclick=handleResize,useHueCheckBox.onmousedown=suppressEvent),a=addOptionElement(a,'<input type="checkbox" id="collapse" checked="checked" />Collapse',"Collapse wedges that are redundant (entirely composed of another wedge)"),a=addOptionElement(a+5,'<input type="button" id="snapshot" value="Snapshot"/>',"Render the current view as SVG (Scalable Vector Graphics), a publication-quality format that can be printed and saved (see Help for browser compatibility)"),a=addOptionElement(a+5,'<input type="button" id="linkButton" value="Link"/><input type="text" size="30" id="linkText"/>',"Show a link to this view that can be copied for bookmarking or sharing"),a=addOptionElement(a+5,'<input type="button" id="help" value="?"onclick="window.open(\'https://github.com/marbl/Krona/wiki/Browsing%20Krona%20charts\', \'help\')"/>',"Help")}function arrow(e,t,a){if(0!=context.globalAlpha){var i=(e+t)/2,s=a-gRadius/10,n=1.1*gRadius,o=(s+n)/2,r=(n-s)/5;context.fillStyle=highlightFill,context.lineWidth=highlightLineWidth,context.beginPath(),context.arc(0,0,a,i,t,!1),context.lineTo(s*Math.cos(t),s*Math.sin(t)),context.lineTo(o*Math.cos(t)-r*Math.sin(t),o*Math.sin(t)+r*Math.cos(t)),context.lineTo(n*Math.cos(t),n*Math.sin(t)),context.arc(0,0,gRadius,t,i,!0),context.closePath(),context.moveTo(-imageWidth,-imageHeight),context.lineTo(imageWidth,-imageHeight),context.lineTo(imageWidth,imageHeight),context.lineTo(-imageWidth,imageHeight),context.closePath(),context.save(),context.clip(),context.beginPath(),context.arc(0,0,a,i,e,!0),context.lineTo(s*Math.cos(e),s*Math.sin(e)),context.lineTo(o*Math.cos(e)+r*Math.sin(e),o*Math.sin(e)-r*Math.cos(e)),context.lineTo(n*Math.cos(e),n*Math.sin(e)),context.arc(0,0,gRadius,e,i,!1),context.fill(),context.stroke(),context.restore(),context.beginPath(),context.arc(0,0,a,i-2/(2*Math.PI*a),t,!1),context.lineTo(s*Math.cos(t),s*Math.sin(t)),context.lineTo(o*Math.cos(t)-r*Math.sin(t),o*Math.sin(t)+r*Math.cos(t)),context.lineTo(n*Math.cos(t),n*Math.sin(t)),context.arc(0,0,gRadius,t,i-2/(2*Math.PI*gRadius),!0),context.fill(),context.stroke()}}function attributeIndex(e){for(var t=0;t<attributes.length;t++)if(e==attributes[t].name)return t;return null}function checkHighlight(){highlightedNode=selectedNode,resetKeyOffset(),1==progress&&(selectedNode.checkHighlight(),selectedNode.getParent()&&selectedNode.getParent().checkHighlightCenter(),focusNode.checkHighlightMap()),1==progress&&draw()}function checkSelectedCollapse(){for(var e=selectedNode;e.getCollapse();)e=e.children[0];0==e.children.length&&e.getParent()&&(e=e.getParent()),e!=selectedNode&&selectNode(e)}function clearSearch(){""!=search.value&&(search.value="",onSearchChange())}function createSVG(){var e=document.createElementNS("http://www.w3.org/2000/svg","svg:svg");return e.setAttribute("id","canvas"),e.setAttribute("width","100%"),e.setAttribute("height","100%"),e.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),e}function degrees(e){return 180*e/Math.PI}function draw(){tweenFrames++,context.clearRect(0,0,imageWidth,imageHeight),context.font=fontNormal,context.textBaseline="middle",context.translate(centerX,centerY),resetKeyOffset(),head.draw(!1,!1),head.draw(!0,!1);var e=selectedNode;0!=focusNode&&focusNode!=selectedNode&&(context.globalAlpha=1,focusNode.drawHighlight(!0),e=focusNode),highlightedNode&&highlightedNode.getDepth()>=selectedNode.getDepth()&&highlightedNode!=focusNode?1==progress&&highlightedNode!=selectedNode&&(highlightedNode!=focusNode||focusNode.children.length>0)&&(context.globalAlpha=1,highlightedNode.drawHighlight(!0)):1==progress&&highlightedNode.getDepth()<selectedNode.getDepth()&&(context.globalAlpha=1,highlightedNode.drawHighlightCenter()),progress<1&&(zoomOut?selectedNodeLast&&(context.globalAlpha=1-4*Math.pow(progress-.5,2),selectedNodeLast.drawHighlight(!1)):(context.globalAlpha=selectedNode.alphaLine.current(),selectedNode.drawHighlight(!0))),drawDatasetName(),context.translate(-centerX,-centerY),context.globalAlpha=1,(mapRadius=(imageHeight/2-details.clientHeight-details.offsetTop)/(e.getDepth()-1)*3/4/2)>maxMapRadius&&(mapRadius=maxMapRadius),mapBuffer=mapRadius/2,e.drawMap(e),hueDisplayName&&useHue()&&drawLegend()}function drawBubble(e,t,a,i,s){var n,o,r=2*fontSize;a+=fontSize,i?(o=-fontSize,n=s?t-a+fontSize/2:t-fontSize/2):(n=-a/2,o=-t-fontSize),snapshotMode?drawBubbleSVG(n+centerX,o+centerY,a,r,fontSize,e):drawBubbleCanvas(n,o,a,r,fontSize,e)}function drawBubbleCanvas(e,t,a,i,s,n){context.strokeStyle="black",context.lineWidth=highlightLineWidth,context.fillStyle="rgba(255, 255, 255, .75)",context.rotate(n),roundedRectangle(e,t,a,2*fontSize,fontSize),context.fill(),context.stroke(),context.rotate(-n)}function drawBubbleSVG(e,t,a,i,s,n){svg+='<rect x="'+e+'" y="'+t+'" width="'+a+'" height="'+i+'" rx="'+s+'" ry="'+s+'" fill="rgba(255, 255, 255, .75)" class="highlight" transform="rotate('+degrees(n)+","+centerX+","+centerY+')"/>'}function drawDatasetName(){var e=datasetAlpha.current();if(e>0){var t=gRadius*compressedRadii[0]/-2;e>1&&(e=1),context.globalAlpha=e,drawBubble(0,-t,datasetWidths[currentDataset],!1,!1),drawText(datasetNames[currentDataset],0,t,0,"center",!0)}}function drawHistory(){var e=1;context.textAlign="center";for(var t=0;t<nodeHistoryPosition&&e>0;t++)context.globalAlpha=e-historyAlphaDelta*tweenFactor,context.fillText(nodeHistory[nodeHistoryPosition-t-1].name,0,(t+tweenFactor)*historySpacingFactor*fontSize-1),e>0&&(e-=historyAlphaDelta);context.globalAlpha=1}function drawLegend(){var e=.01*imageWidth,t=.0265*imageHeight,a=.15*imageHeight,i=imageHeight-3.5*fontSize-a,s=e+t+fontSize/2;context.fillStyle="black",context.textAlign="start",context.font=fontNormal,context.fillText(hueDisplayName,e,imageHeight-1.5*fontSize);for(var n=context.createLinearGradient(0,i+a,0,i),o=0;o<hueStopPositions.length;o++){n.addColorStop(hueStopPositions[o],hueStopHsl[o]);var r=i+(1-hueStopPositions[o])*a;(0==o||o==hueStopPositions.length-1||r>i+fontSize&&r<i+a-fontSize)&&context.fillText(hueStopText[o],s,r)}context.fillStyle=n,context.fillRect(e,i,t,a),context.lineWidth=thinLineWidth,context.strokeRect(e,i,t,a)}function drawLegendSVG(){var e=.01*imageWidth,t=.0265*imageHeight,a=.15*imageHeight,i=imageHeight-3.5*fontSize-a,s=e+t+fontSize/2,n="";n+=svgText(hueDisplayName,e,imageHeight-1.5*fontSize);for(var o='<linearGradient id="gradient" x1="0%" y1="100%" x2="0%" y2="0%">',r=0;r<hueStopPositions.length;r++){o+='<stop offset="'+round(100*hueStopPositions[r])+'%" style="stop-color:'+hueStopHsl[r]+'"/>';var h=i+(1-hueStopPositions[r])*a;(0==r||r==hueStopPositions.length-1||h>i+fontSize&&h<i+a-fontSize)&&(n+=svgText(hueStopText[r],s,h))}svg+=o+="</linearGradient>",svg+='<rect style="fill:url(#gradient)" x="'+e+'" y="'+i+'" width="'+t+'" height="'+a+'"/>',svg+=n}function drawSearchHighlights(e,t,a,i,s){var n=-1,o=e.length;t-=fontSize/4;do{if(-1!=(n=e.toLowerCase().indexOf(search.value.toLowerCase(),n+1))&&n<o){var r=context.measureText(e.substr(0,n)),h=t+r.width;r=context.measureText(e.substr(n,search.value.length));var l=a-3*fontSize/4,d=r.width+fontSize/2,c=3*fontSize/2,u=fontSize/2;snapshotMode?(s&&(h+=centerX,l+=centerY),svg+='<rect x="'+h+'" y="'+l+'" width="'+d+'" height="'+c+'" rx="'+u+'" ry="'+u+'" class="searchHighlight" transform="rotate('+degrees(i)+","+centerX+","+centerY+')"/>'):(context.fillStyle="rgb(255, 255, 100)",context.rotate(i),roundedRectangle(h,l,d,c,u),context.fill(),context.rotate(-i))}}while(-1!=n&&n<o)}function drawText(e,t,a,i,s,n,o){null==o&&(o="black"),snapshotMode?svg+='<text x="'+(centerX+t)+'" y="'+(centerY+a)+'" text-anchor="'+s+'" style="font-color:'+o+";font-weight:"+(n?"bold":"normal")+'" transform="rotate('+degrees(i)+","+centerX+","+centerY+')">'+e+"</text>":(context.fillStyle=o,context.textAlign=s,context.font=n?fontBold:fontNormal,context.rotate(i),context.fillText(e,t,a),context.rotate(-i))}function drawTextPolar(e,t,a,i,s,n,o,r,h){var l,d,c,u,g,p=e;if(u=snapshotMode?"&#160;&#160;&#160;":"   ",s?((g=a<3*Math.PI/2)?(a-=Math.PI,i=-i,l="end",t&&(p=e+u+t)):(l="start",t&&(p=t+u+e)),d=i,c=0):(g=a<Math.PI||a>2*Math.PI,l=snapshotMode?"middle":"center",g&&(a-=Math.PI,i=-i),a+=Math.PI/2,d=0,c=-i),n){var f=p;t&&snapshotMode&&(f=g?e+"   "+t:t+"   "+e),h&&(f+=searchResultString(h));var m=measureText(f,o),b=d;"end"==l?b-=m:"start"!=l&&(b-=m/2),drawBubble(a,i,m,s,g),r&&drawSearchHighlights(f,b,c,a,!0)}return h&&(p+=searchResultString(h)),drawText(p,d,c,a,l,o),g}function drawTick(e,t,a){snapshotMode?svg+='<line x1="'+(centerX+e)+'" y1="'+centerY+'" x2="'+(centerX+e+t)+'" y2="'+centerY+'" class="tick" transform="rotate('+degrees(a)+","+centerX+","+centerY+')"/>':(context.rotate(a),context.beginPath(),context.moveTo(e,0),context.lineTo(e+t,0),context.lineWidth=2*thinLineWidth,context.stroke(),context.rotate(-a))}function drawWedge(e,t,a,i,s,n,o){if(0!=context.globalAlpha)if(snapshotMode){t==e+2*Math.PI&&(t-=.1/gRadius);var r=t-e>Math.PI?1:0,h=centerX+a*Math.cos(e),l=centerY+a*Math.sin(e),d=centerX+gRadius*Math.cos(e),c=centerY+gRadius*Math.sin(e),u=centerX+gRadius*Math.cos(t),g=centerY+gRadius*Math.sin(t),p=centerX+a*Math.cos(t),f=centerY+a*Math.sin(t),m=[" M ",h,",",l," L ",d,",",c," A ",gRadius,",",gRadius," 0 ",r,",1 ",u,",",g," L ",p,",",f," A ",a,",",a," 0 ",r," 0 ",h,",",l," Z "];svg+='<path class="'+(o?"highlight":"wedge")+'" fill="'+s+'" d="'+m.join("")+'"/>',n>0&&(svg+='<path class="wedge" fill="url(#hiddenPattern)" d="'+m.join("")+'"/>')}else t+=1/gRadius,context.fillStyle=s,context.beginPath(),context.arc(0,0,a,e,t,!1),context.arc(0,0,i,t,e,!0),context.closePath(),context.fill(),n>0&&(context.save(),context.clip(),context.globalAlpha=n,context.fillStyle=hiddenPattern,context.fill(),context.restore()),o&&(context.lineWidth=o?highlightLineWidth:thinLineWidth,context.strokeStyle="black",context.stroke())}function expand(e){selectNode(e),updateView()}function focusLost(){mouseX=-1,mouseY=-1,checkHighlight(),document.body.style.cursor="auto"}function fontSizeDecrease(){fontSize>1&&(fontSize--,updateViewNeeded=!0)}function fontSizeIncrease(){fontSize++,updateViewNeeded=!0}function getGetString(e,t,a){return e+"="+(a?t?"true":"false":t)}function hideLink(){hide(linkText),show(linkButton)}function show(e){e.style.display="inline"}function hide(e){e.style.display="none"}function showLink(){var e=String(document.location).split("?"),t=[];t.push(getGetString("dataset",currentDataset,!1),getGetString("node",selectedNode.id,!1),getGetString("collapse",collapse,!0),getGetString("color",useHue(),!0),getGetString("depth",maxAbsoluteDepth-1,!1),getGetString("font",fontSize,!1),getGetString("key",showKeys,!0)),hide(linkButton),show(linkText),linkText.value=e[0]+"?"+getVariables.concat(t).join("&"),linkText.focus(),linkText.select()}function getFirstChild(e){return(e=e.firstChild)&&1!=e.nodeType&&(e=getNextSibling(e)),e}function getNextSibling(e){do{e=e.nextSibling}while(e&&1!=e.nodeType);return e}function getPercentage(e){return round(100*e)}function hslText(e){var t=hslToRgb(e,saturation,(lightnessBase+lightnessMax)/2);return rgbText(t.r,t.g,t.b)}function hslToRgb(e,t,a){var i,s,n,o,r;return 0==t?n=o=r=Math.floor(255*a):(i=2*a-(s=a<=.5?a*(t+1):a+t-a*t),n=Math.floor(hueToRgb(i,s,e+1/3)),o=Math.floor(hueToRgb(i,s,e)),r=Math.floor(hueToRgb(i,s,e-1/3))),{r:n,g:o,b:r}}function hueToRgb(e,t,a){for(;a<0;)a+=1;for(;a>1;)a-=1;return 255*(6*a<1?e+(t-e)*a*6:2*a<1?t:3*a<2?e+(t-e)*(2/3-a)*6:e)}function interpolateHue(e,t,a,i){hueStopText=[],hueStopHsl=[],(hueStopPositions=[]).push(0),hueStopHsl.push(hslText(e)),hueStopText.push(round(a));for(var s=e>t?5/6:1/6;e>t?s>0:s<1;s+=(e>t?-1:1)/6)(e>t?s>t&&s<e:s>e&&s<t)&&(hueStopPositions.push(lerp(s,e,t,0,1)),hueStopHsl.push(hslText(s)),hueStopText.push(round(lerp(s,e,t,a,i))));hueStopPositions.push(1),hueStopHsl.push(hslText(t)),hueStopText.push(round(i))}function keyLineAngle(e,t,a,i,s,n,o){if(e<Math.PI/2&&s<a*Math.sin(e)||e>Math.PI/2&&s<a)return Math.asin(s/a);var r=Math.sqrt(Math.pow(i,2)+Math.pow(s,2)),h=Math.acos(a/r)+t;return e<h||e<Math.PI/2?(s/Math.tan(e)>0?(n.push(s/Math.tan(e)),o.push(s)):(n.push(a*Math.cos(e)),o.push(a*Math.sin(e))),e):h}function keyOffset(){return imageHeight-(keys-currentKey+1)*(keySize+keyBuffer)+keyBuffer-margin}function lerp(e,t,a,i,s){return(e-t)*(s-i)/(a-t)+i}function createCanvas(){canvas=document.createElement("canvas"),document.body.appendChild(canvas),context=canvas.getContext("2d")}function load(){if(document.body.style.overflow="hidden",document.body.style.margin=0,createCanvas(),null!=context)if("function"==typeof context.fillText){resize();var e,t,a,i,s,n,o,r=document.getElementsByTagName("krona")[0];null!=r.getAttribute("collapse")&&(collapse="true"==r.getAttribute("collapse")),null!=r.getAttribute("key")&&(showKeys="true"==r.getAttribute("key"));for(var h=getFirstChild(r);h;h=getNextSibling(h))switch(h.tagName.toLowerCase()){case"attributes":e=h.getAttribute("magnitude");for(var l=getFirstChild(h);l;l=getNextSibling(l)){var d=l.tagName.toLowerCase();if("attribute"==d)(c=new Attribute).name=l.firstChild.nodeValue.toLowerCase(),c.displayName=l.getAttribute("display"),l.getAttribute("hrefBase")&&(c.hrefBase=l.getAttribute("hrefBase")),l.getAttribute("target")&&(c.target=l.getAttribute("target")),c.name==e&&(magnitudeIndex=attributes.length),l.getAttribute("listAll")?c.listAll=l.getAttribute("listAll").toLowerCase():l.getAttribute("listNode")?c.listNode=l.getAttribute("listNode").toLowerCase():l.getAttribute("dataAll")?c.dataAll=l.getAttribute("dataAll").toLowerCase():l.getAttribute("dataNode")&&(c.dataNode=l.getAttribute("dataNode").toLowerCase()),l.getAttribute("postUrl")&&(c.postUrl=l.getAttribute("postUrl")),l.getAttribute("postVar")&&(c.postVar=l.getAttribute("postVar")),l.getAttribute("mono")&&(c.mono=!0),attributes.push(c);else if("list"==d)(c=new Attribute).name=l.firstChild.nodeValue,c.list=!0,attributes.push(c);else if("data"==d){var c;(c=new Attribute).name=l.firstChild.nodeValue,c.data=!0,attributes.push(c);var u=document.createElement("script"),g=new Date;u.src=l.getAttribute("enable")+"?"+g.getTime(),document.body.appendChild(u)}}break;case"color":t=h.getAttribute("attribute"),interpolateHue(i=Number(h.getAttribute("hueStart"))/360,s=Number(h.getAttribute("hueEnd"))/360,n=Number(h.getAttribute("valueStart")),o=Number(h.getAttribute("valueEnd"))),"true"==h.getAttribute("default")&&(a=!0);break;case"datasets":let r;for(datasetNames=[],r=getFirstChild(h);r;r=getNextSibling(r))datasetNames.push(r.firstChild.nodeValue);datasets=datasetNames.length;break;case"node":head=loadTreeDOM(h,e,t,i,s,n,o)}var p,f=String(document.location).split("?"),m=0,b=0;if(f[1]){var x=f[1].split("&");let e;for(e=0;e<x.length;e++){var y=x[e].split("=");switch(y[0]){case"collapse":collapse="true"==y[1];break;case"color":a="true"==y[1];break;case"dataset":m=Number(y[1]);break;case"depth":p=Number(y[1])+1;break;case"key":showKeys="true"==y[1];break;case"font":fontSize=Number(y[1]);break;case"node":b=Number(y[1]);break;default:getVariables.push(y[0]+"="+y[1])}}}addOptionElements(t,a),setCallBacks(),head.sort(),maxAbsoluteDepth=0,selectDataset(m),maxAbsoluteDepth=p&&p<head.maxDepth?p:head.maxDepth,selectNode(nodes[b]),setInterval(update,20),window.onresize=handleResize,updateMaxAbsoluteDepth(),updateViewNeeded=!0}else document.body.innerHTML='<br/>This browser does not support HTML5 canvas text (see <a href="https://github.com/marbl/Krona/wiki/Browser%20support">Browser support</a>).\t';else document.body.innerHTML='<br/>This browser does not support HTML5 (see <a href="https://github.com/marbl/Krona/wiki/Browser%20support">Browser support</a>).\t'}function loadTreeDOM(e,t,a,i,s,n,o){var r=new Node;r.name=e.getAttribute("name"),e.getAttribute("href")&&(r.href=e.getAttribute("href")),a&&(r.hues=[]);for(var h=getFirstChild(e);h;h=getNextSibling(h))if("node"===h.tagName.toLowerCase()){var l=loadTreeDOM(h,t,a,i,s,n,o);l.parent=r,r.children.push(l)}else{var d=h.tagName.toLowerCase(),c=attributeIndex(d);r.attributes[c]=[];for(var u=getFirstChild(h);u;u=getNextSibling(u))if(attributes[c],attributes[c].list){r.attributes[c].push([]);for(var g=getFirstChild(u);g;g=getNextSibling(g))r.attributes[c][r.attributes[c].length-1].push(g.firstChild.nodeValue)}else{var p,f=u.firstChild?u.firstChild.nodeValue:"";u.getAttribute("href")&&(attributes[c].target&&(p=' target="'+attributes[c].target+'"'),f='<a href="'+attributes[c].hrefBase+u.getAttribute("href")+'"'+p+">"+f+"</a>"),r.attributes[c].push(f)}if(d==t||d==a){for(u=0;u<datasets;u++)if(f=null==r.attributes[c][u]?0:Number(r.attributes[c][u]),r.attributes[c][u]=f,d==a){var m=lerp(f,n,o,i,s);m<i==i<s?m=i:m>s==i<s&&(m=s),r.hues[u]=m}d==a&&(r.hue=new Tween(r.hues[0],r.hues[0]))}}return r}function maxAbsoluteDepthDecrease(){maxAbsoluteDepth>2&&(maxAbsoluteDepth--,head.setMaxDepths(),handleResize())}function maxAbsoluteDepthIncrease(){maxAbsoluteDepth<head.maxDepth&&(maxAbsoluteDepth++,head.setMaxDepths(),handleResize())}function measureText(e,t){return context.font=t?fontBold:fontNormal,context.measureText(e).width}function min(e,t){return e<t?e:t}function minWidth(){return 2.3*fontSize}function mouseMove(e){mouseX=e.pageX,mouseY=e.pageY-headerHeight,mouseXRel=(mouseX-centerX)*backingScale(),mouseYRel=(mouseY-centerY)*backingScale(),head&&!quickLook&&checkHighlight()}function mouseClick(e){if(highlightedNode==focusNode&&focusNode!=selectedNode||selectedNode.hasParent(highlightedNode))highlightedNode.hasChildren()&&expand(highlightedNode);else if(1==progress){setFocus(highlightedNode),draw(),checkHighlight();var t=new Date;mouseDownTime=t.getTime(),mouseDown=!0}}function mouseUp(e){quickLook&&(navigateBack(),quickLook=!1),mouseDown=!1}function navigateBack(){nodeHistoryPosition>0&&(nodeHistory[nodeHistoryPosition]=selectedNode,nodeHistoryPosition--,nodeHistory[nodeHistoryPosition].collapse&&(collapseCheckBox.checked=collapse=!1),setSelectedNode(nodeHistory[nodeHistoryPosition]),updateDatasetButtons(),updateView())}function navigateUp(){selectedNode.getParent()&&(selectNode(selectedNode.getParent()),updateView())}function navigateForward(){if(nodeHistoryPosition<nodeHistory.length-1){nodeHistoryPosition++;var e=nodeHistory[nodeHistoryPosition];e.collapse&&(collapseCheckBox.checked=collapse=!1),nodeHistoryPosition==nodeHistory.length-1&&(nodeHistory.length=nodeHistoryPosition),setSelectedNode(e),updateDatasetButtons(),updateView()}}function nextDataset(){var e=currentDataset;do{e==datasets-1?e=0:e++}while(datasetDropDown.options[e].disabled);selectDataset(e)}function onDatasetChange(){selectDataset(datasetDropDown.selectedIndex)}function onKeyDown(e){37==e.keyCode&&"search"!=document.activeElement.id&&"linkText"!=document.activeElement.id?(navigateBack(),e.preventDefault()):39==e.keyCode&&"search"!=document.activeElement.id&&"linkText"!=document.activeElement.id?(navigateForward(),e.preventDefault()):38==e.keyCode&&datasets>1?(prevDataset(),e.preventDefault()):40==e.keyCode&&datasets>1?(nextDataset(),e.preventDefault()):9==e.keyCode&&datasets>1?(selectLastDataset(),e.preventDefault()):83==e.keyCode?progress+=.2:66==e.keyCode?progress-=.2:70==e.keyCode&&(progress=1)}function onKeyPress(e){(38==e.keyCode&&datasets>1||40==e.keyCode&&datasets>1)&&e.preventDefault()}function onKeyUp(e){27==e.keyCode&&"search"==document.activeElement.id?(search.value="",onSearchChange()):(38==e.keyCode&&datasets>1||40==e.keyCode&&datasets>1)&&e.preventDefault()}function onSearchChange(){nSearchResults=0,head.search(),""==search.value?searchResults.innerHTML="":searchResults.innerHTML=nSearchResults+" results",setFocus(selectedNode),draw()}function post(e,t,a,i){var s=document.createElement("form"),n=document.createElement("input"),o=document.createElement("input");s.appendChild(n),s.appendChild(o),s.method="POST",s.action=e,null==i&&(s.target="_blank",i=window),n.type="hidden",n.name=t,n.value=a,o.type="hidden",o.name="dataset",o.value=currentDataset,i.document.body.appendChild(s),s.submit()}function prevDataset(){var e=currentDataset;do{0==e?e=datasets-1:e--}while(datasetDropDown.options[e].disabled);selectDataset(e)}function radiusDecrease(){bufferFactor<.309&&(bufferFactor+=.03,updateViewNeeded=!0)}function radiusIncrease(){bufferFactor>.041&&(bufferFactor-=.03,updateViewNeeded=!0)}function resetKeyOffset(){currentKey=1,keyMinTextLeft=centerX+gRadius+buffer-buffer/(keys+1)/2+fontSize/2,keyMinAngle=0}function rgbText(e,t,a){return["rgb(",Math.floor(e),",",Math.floor(t),",",Math.floor(a),")"].join("")}function round(e){return e>=1||e<=-1?e.toFixed(0):e.toPrecision(1)}function roundedRectangle(e,t,a,i,s){2*s>a&&(s=a/2),2*s>i&&(s=i/2),context.beginPath(),context.arc(e+s,t+s,s,Math.PI,3*Math.PI/2,!1),context.lineTo(e+a-s,t),context.arc(e+a-s,t+s,s,3*Math.PI/2,2*Math.PI,!1),context.lineTo(e+a,t+i-s),context.arc(e+a-s,t+i-s,s,0,Math.PI/2,!1),context.lineTo(e+s,t+i),context.arc(e+s,t+i-s,s,Math.PI/2,Math.PI,!1),context.lineTo(e,t+s)}function passClick(e){mouseClick(e)}function searchResultString(e){return this.searchResults,this.isSearchResult," - "+e+(e>1?" results":" result")}function setCallBacks(){canvas.onselectstart=function(){return!1},options.onselectstart=function(){return!1},document.onmousemove=mouseMove,window.onblur=focusLost,window.onmouseout=focusLost,document.onkeyup=onKeyUp,document.onkeydown=onKeyDown,canvas.onmousedown=mouseClick,document.onmouseup=mouseUp,keyControl.onclick=toggleKeys,(collapseCheckBox=document.getElementById("collapse")).checked=collapse,collapseCheckBox.onclick=handleResize,collapseCheckBox.onmousedown=suppressEvent,maxAbsoluteDepthText=document.getElementById("maxAbsoluteDepth"),maxAbsoluteDepthButtonDecrease=document.getElementById("maxAbsoluteDepthDecrease"),maxAbsoluteDepthButtonIncrease=document.getElementById("maxAbsoluteDepthIncrease"),maxAbsoluteDepthButtonDecrease.onclick=maxAbsoluteDepthDecrease,maxAbsoluteDepthButtonIncrease.onclick=maxAbsoluteDepthIncrease,maxAbsoluteDepthButtonDecrease.onmousedown=suppressEvent,maxAbsoluteDepthButtonIncrease.onmousedown=suppressEvent,fontSizeText=document.getElementById("fontSize"),fontSizeButtonDecrease=document.getElementById("fontSizeDecrease"),fontSizeButtonIncrease=document.getElementById("fontSizeIncrease"),fontSizeButtonDecrease.onclick=fontSizeDecrease,fontSizeButtonIncrease.onclick=fontSizeIncrease,fontSizeButtonDecrease.onmousedown=suppressEvent,fontSizeButtonIncrease.onmousedown=suppressEvent,radiusButtonDecrease=document.getElementById("radiusDecrease"),radiusButtonIncrease=document.getElementById("radiusIncrease"),radiusButtonDecrease.onclick=radiusDecrease,radiusButtonIncrease.onclick=radiusIncrease,radiusButtonDecrease.onmousedown=suppressEvent,radiusButtonIncrease.onmousedown=suppressEvent,maxAbsoluteDepth=0,(backButton=document.getElementById("back")).onclick=navigateBack,backButton.onmousedown=suppressEvent,(forwardButton=document.getElementById("forward")).onclick=navigateForward,forwardButton.onmousedown=suppressEvent,(snapshotButton=document.getElementById("snapshot")).onclick=snapshot,snapshotButton.onmousedown=suppressEvent,detailsName=document.getElementById("detailsName"),detailsExpand=document.getElementById("detailsExpand"),detailsInfo=document.getElementById("detailsInfo"),(search=document.getElementById("search")).onkeyup=onSearchChange,search.onmousedown=suppressEvent,searchResults=document.getElementById("searchResults"),useHueDiv=document.getElementById("useHueDiv"),(linkButton=document.getElementById("linkButton")).onclick=showLink,linkButton.onmousedown=suppressEvent,(linkText=document.getElementById("linkText")).onblur=hideLink,linkText.onmousedown=suppressEvent,hide(linkText),document.getElementById("help").onmousedown=suppressEvent,document.getElementById("searchClear").onmousedown=suppressEvent,datasets>1&&(datasetDropDown.onmousedown=suppressEvent,document.getElementById("prevDataset").onmousedown=suppressEvent,document.getElementById("nextDataset").onmousedown=suppressEvent,document.getElementById("lastDataset").onmousedown=suppressEvent),(image=document.getElementById("hiddenImage")).onload=function(){hiddenPattern=context.createPattern(image,"repeat")};var e=document.getElementById("loadingImage");e&&(loadingImage=e.src)}function selectDataset(e){lastDataset=currentDataset,currentDataset=e,datasets>1&&(datasetDropDown.selectedIndex=currentDataset,updateDatasetButtons(),datasetAlpha.start=1.5,datasetChanged=!0),head.setMagnitudes(0),head.setDepth(1,1),head.setMaxDepths(),handleResize()}function selectLastDataset(){selectDataset(lastDataset),handleResize()}function selectNode(e){selectedNode!=e&&(nodeHistory.length=nodeHistoryPosition,0!=selectedNode&&(nodeHistory.push(selectedNode),nodeHistoryPosition++),setSelectedNode(e)),updateDatasetButtons()}function setFocus(e){focusNode=e,e.href?detailsName.innerHTML='<a target="_blank" href="'+e.href+'">'+e.name+"</a>":detailsName.innerHTML=e.name;var t="<table>";t+="<tr><td></td><td></td></tr>";for(var a=0;a<e.attributes.length;a++)if(attributes[a].displayName&&null!=e.attributes[a]){var i=1==e.attributes[a].length&&attributes[a].mono?0:currentDataset;if("number"==typeof e.attributes[a][currentDataset]||null!=e.attributes[a][i]&&""!=e.attributes[a][currentDataset]){var s=e.attributes[a][i];null!=attributes[a].listNode?s='<a href="" onclick="showList('+attributeIndex(attributes[a].listNode)+","+a+',false);return false;" title="Show list">'+s+"</a>":null!=attributes[a].listAll?s='<a href="" onclick="showList('+attributeIndex(attributes[a].listAll)+","+a+',true);return false;" title="Show list">'+s+"</a>":null!=attributes[a].dataNode&&dataEnabled?s='<a href="" onclick="showData('+attributeIndex(attributes[a].dataNode)+","+a+',false);return false;" title="Show data">'+s+"</a>":null!=attributes[a].dataAll&&dataEnabled&&(s='<a href="" onclick="showData('+attributeIndex(attributes[a].dataAll)+","+a+',true);return false;" title="Show data">'+s+"</a>"),t+="<tr><td><strong>"+attributes[a].displayName+":</strong></td><td>"+s+"</td></tr>"}}t+="</table>",detailsInfo.innerHTML=t,detailsExpand.disabled=!focusNode.hasChildren()||focusNode==selectedNode}function setSelectedNode(e){zoomOut=!(!selectedNode||!selectedNode.hasParent(e)),selectedNodeLast=selectedNode,setFocus(selectedNode=e)}function waitForData(e,t,a,i,s,n){if(nodeData.length==t){if(null!=s){for(var o=0;o<nodeData.length;o++)nodeData[o]=nodeData[o].replace(/\n/g,",");var r=nodeData.join("");r=r.slice(0,-1),e.document.body.removeChild(e.document.getElementById("loading")),document.body.removeChild(document.getElementById("data")),post(s,n,r,e)}else e.document.open(),e.document.write("<pre>"+nodeData.join("")+"</pre>"),e.document.close();e.document.title=a}else(new Date).getTime()-i>1e4?(e.document.body.removeChild(e.document.getElementById("loading")),document.body.removeChild(document.getElementById("data")),e.document.body.innerHTML="Timed out loading supplemental files for:<br/>"+document.location):setTimeout((function(){waitForData(e,t,a,i,s,n)}),100)}function data(e){nodeData.push(e)}function enableData(){dataEnabled=!0}function showData(e,t,a){var i=window.open("","_blank"),s="Krona - "+attributes[t].displayName+" - "+focusNode.name;i.document.title=s,nodeData=[],i&&i.document&&null!=i.document.body&&(i.document.body.innerHTML='<img id="loading" src="'+loadingImage+'" alt="Loading..."></img>');var n=document.createElement("div");n.id="data",document.body.appendChild(n);for(var o=focusNode.getData(e,a),r=(new Date).getTime(),h=0;h<o.length;h++){var l=document.createElement("script");l.src=o[h]+"?"+r,n.appendChild(l)}return waitForData(i,o.length,s,r,attributes[t].postUrl,attributes[t].postVar),!1}function showList(e,t,a){var i=focusNode.getList(e,a);if(null!=attributes[t].postUrl)post(attributes[t].postUrl,attributes[t].postVar,i.join(","));else{var s=window.open("","_blank");s.document.open(),s.document.write("<pre>"+i.join("\n")+"</pre>"),s.document.close(),s.document.title="Krona - "+attributes[t].displayName+" - "+focusNode.name}}function snapshot(){svg=svgHeader(),resetKeyOffset(),snapshotMode=!0,selectedNode.draw(!1,!0),selectedNode.draw(!0,!0),0!=focusNode&&focusNode!=selectedNode&&(context.globalAlpha=1,focusNode.drawHighlight(!0)),hueDisplayName&&useHue()&&drawLegendSVG(),snapshotMode=!1,svg+=svgFooter();var e=window.open("","_blank","","replace=false");e.document.write('<html><body><a href="data:image/svg+xml,'+encodeURIComponent(svg)+'" download="snapshot.svg">Download Snapshot</a></html></body>'),e.document.write(svg)}function save(){alert(document.body.innerHTML)}function spacer(){return snapshotMode?"&#160;&#160;&#160;":"   "}function suppressEvent(e){e.cancelBubble=!0,e.stopPropagation&&e.stopPropagation()}function svgFooter(){return"</svg>"}function svgHeader(){var e=.6*fontSize;return'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" \t"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg width="'+imageWidth+'" height="'+imageHeight+'" version="1.1"\txmlns="http://www.w3.org/2000/svg"><title>Krona (snapshot) - '+(datasets>1?datasetNames[currentDataset]+" - ":"")+selectedNode.name+'</title><defs>\t<style type="text/css">\ttext {font-size: '+fontSize+"px; font-family: "+fontFamily+"; dominant-baseline:central}\tpath {stroke-width:"+thinLineWidth*fontSize/12+";}\tpath.wedge {stroke:none}\tpath.line {fill:none;stroke:black;}\tline {stroke:black;stroke-width:"+thinLineWidth*fontSize/12+";}\tline.tick {stroke-width:"+thinLineWidth*fontSize/6+";}\tline.pattern {stroke-width:"+thinLineWidth*fontSize/18+";}\tcircle {fill:none;stroke:black;stroke-width:"+thinLineWidth*fontSize/12+";}\trect {stroke:black;stroke-width:"+thinLineWidth*fontSize/12+";}\t.highlight {stroke:black;stroke-width:"+highlightLineWidth*fontSize/12+';}\t.searchHighlight {fill:rgb(255, 255, 100);stroke:none;}\t</style><pattern id="hiddenPattern" patternUnits="userSpaceOnUse" x="0" y="0" width="'+e+'" height="'+e+'"><line class="pattern" x1="0" y1="0" x2="'+e/2+'" y2="'+e/2+'"/><line class="pattern" x1="'+e/2+'" y1="'+e+'" x2="'+e+'" y2="'+e/2+'"/></pattern></defs>'}function svgText(e,t,a,i,s,n){return void 0===i&&(i="start"),null==n&&(n="black"),'<text x="'+t+'" y="'+a+'" style="font-color:'+n+";font-weight:"+(s?"bold":"normal")+'" text-anchor="'+i+'">'+e+"</text>"}function toggleKeys(){showKeys?(keyControl.value="…",showKeys=!1):(keyControl.value="x",showKeys=!0),updateKeyControl(),1==progress&&draw()}function update(){if(head){mouseDown&&focusNode!=selectedNode&&(e=new Date).getTime()-mouseDownTime>quickLookHoldLength&&focusNode.hasChildren()&&(expand(focusNode),quickLook=!0),updateViewNeeded&&(resize(),mouseX=-1,mouseY=-1,collapse=collapseCheckBox.checked,compress=!0,shorten=!0,checkSelectedCollapse(),updateMaxAbsoluteDepth(),focusNode.getCollapse()||focusNode.depth>maxAbsoluteDepth?setFocus(selectedNode):setFocus(focusNode),updateView(),updateViewNeeded=!1);var e=new Date;(progress=(e.getTime()-tweenStartTime)/tweenLength)>=1&&(progress=1),progress!=progressLast&&(tweenFactor=(1/(1+Math.exp(-tweenCurvature*(progress-.5)))-.5)/(tweenMax-.5)/2+.5,1==progress&&(snapshotButton.disabled=!1,zoomOut=!1,fpsDisplay&&(fpsDisplay.innerHTML="fps: "+Math.round(1e3*tweenFrames/tweenLength))),draw()),progressLast=progress}}function updateDatasetButtons(){if(1!=datasets){var e=selectedNode||head;datasetButtonLast.disabled=0==e.attributes[magnitudeIndex][lastDataset],datasetButtonPrev.disabled=!0,datasetButtonNext.disabled=!0;for(var t=0;t<datasets;t++){var a=0==e.attributes[magnitudeIndex][t];datasetDropDown.options[t].disabled=a,a||t!=currentDataset&&(datasetButtonPrev.disabled=!1,datasetButtonNext.disabled=!1)}}}function updateDatasetWidths(){if(datasets>1)for(var e=0;e<datasets;e++){context.font=fontBold;var t=context.measureText(datasetNames[e]);datasetWidths[e]=t.width}}function updateKeyControl(){0==keys?keyControl.style.visibility="hidden":(keyControl.style.visibility="visible",keyControl.style.right=margin+"px",keyControl.style.top=showKeys?imageHeight-(keys*(keySize+keyBuffer)-keyBuffer+margin+1.5*keyControl.clientHeight)+"px":imageHeight-margin-keyControl.clientHeight+"px")}function updateView(){selectedNode.depth>maxAbsoluteDepth-1&&(maxAbsoluteDepth=selectedNode.depth+1),highlightedNode=selectedNode,angleFactor=2*Math.PI/selectedNode.magnitude,(maxPossibleDepth=Math.floor(gRadius/(fontSize*minRingWidthFactor)))<4&&(maxPossibleDepth=4);var e,t=8*fontSize/gRadius,a=6*fontSize/gRadius,i=5*fontSize/gRadius;.25<t&&(t=.25),.15<a&&(a=.15),.15<i&&(i=.15);var s=selectedNode.getMaxDepth()-selectedNode.getDepth()+1;do{if(e=s,!compress&&e>maxPossibleDepth&&(e=maxPossibleDepth),compress){(compressedRadii=new Array(e))[0]=t;for(var n=0;lerp(Math.atan(n+2),Math.atan(n+1),Math.atan(e+n-1),t,1-i)-t>a&&n<10;)n++;n--;for(var o=1;o<e;o++)compressedRadii[o]=lerp(Math.atan(o+n),Math.atan(n),Math.atan(e+n-1),t,1-i)}else nodeRadius=1/e;s=selectedNode.maxVisibleDepth(e),compress||s>maxPossibleDepth&&(s=maxPossibleDepth)}while(s<e);for(maxDisplayDepth=e,lightnessFactor=(lightnessMax-lightnessBase)/(e>8?8:e),keys=0,nLabelOffsets=new Array(maxDisplayDepth-1),labelOffsets=new Array(maxDisplayDepth-1),labelLastNodes=new Array(maxDisplayDepth-1),labelFirstNodes=new Array(maxDisplayDepth-1),o=0;o<maxDisplayDepth-1;o++){if(compress)if(o==maxDisplayDepth-1)nLabelOffsets[o]=0;else{var r=(compressedRadii[o+1]-compressedRadii[o])*gRadius;nLabelOffsets[o]=Math.floor(r/fontSize/1.2),nLabelOffsets[o]>2&&(nLabelOffsets[o]=min(Math.floor(r/fontSize/1.75),5))}else nLabelOffsets[o]=Math.max(Math.floor(1.5*Math.sqrt(nodeRadius*gRadius/fontSize)),3);labelOffsets[o]=Math.floor((nLabelOffsets[o]-1)/2),labelLastNodes[o]=new Array(nLabelOffsets[o]+1),labelFirstNodes[o]=new Array(nLabelOffsets[o]+1);for(var h=0;h<=nLabelOffsets[o];h++)labelLastNodes[o][h]=0,labelFirstNodes[o][h]=0}fontSizeText.innerHTML=fontSize,fontNormal=fontSize+"px "+fontFamily,context.font=fontNormal,fontBold="bold "+fontSize+"px "+fontFamily,tickLength=.7*fontSize,head.setTargets(0),(keySize=1*(imageHeight-3*margin)/2/keys*3/4)>fontSize*maxKeySizeFactor&&(keySize=fontSize*maxKeySizeFactor),keyBuffer=keySize/3,fontSizeLast=fontSize,datasetChanged?datasetChanged=!1:datasetAlpha.start=0;var l=new Date;tweenStartTime=l.getTime(),progress=0,tweenFrames=0,updateKeyControl(),updateDatasetWidths(),document.title="Krona - "+selectedNode.name,updateNavigationButtons(),snapshotButton.disabled=!0,maxAbsoluteDepthText.innerHTML=maxAbsoluteDepth-1,maxAbsoluteDepthButtonDecrease.disabled=2==maxAbsoluteDepth,maxAbsoluteDepthButtonIncrease.disabled=maxAbsoluteDepth==head.maxDepth,collapse!=collapseLast&&""!=search.value&&(onSearchChange(),collapseLast=collapse)}function updateMaxAbsoluteDepth(){for(;maxAbsoluteDepth>1&&selectedNode.depth>maxAbsoluteDepth-1;)selectedNode=selectedNode.getParent()}function updateNavigationButtons(){backButton.disabled=0==nodeHistoryPosition,forwardButton.disabled=nodeHistoryPosition==nodeHistory.length}function useHue(){return useHueCheckBox&&useHueCheckBox.checked}window.onload=load;